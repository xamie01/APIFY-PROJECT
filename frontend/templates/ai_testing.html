{% extends "base.html" %}

{% block title %}AI Testing - O-SATE{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-robot"></i> AI Model Testing</h2>
            <p class="text-muted">Test and interact with multiple AI models from various providers</p>
        </div>
    </div>

    <div class="row">
        <!-- Left Panel: Query Form -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-paper-plane"></i> Submit Query</h5>
                </div>
                <div class="card-body">
                    <form id="queryForm">
                        <!-- Model Selection -->
                        <div class="mb-3">
                            <label for="modelSelect" class="form-label">
                                <i class="fas fa-brain"></i> Select Model
                            </label>
                            <select class="form-select" id="modelSelect" required>
                                <option value="">Choose a model...</option>
                                {% for model in models %}
                                <option value="{{ model }}">{{ model }}</option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted">
                                Select from 10+ free AI models via OpenRouter
                            </small>
                        </div>

                        <!-- Prompt Input -->
                        <div class="mb-3">
                            <label for="promptInput" class="form-label">
                                <i class="fas fa-comment"></i> Prompt
                            </label>
                            <textarea 
                                class="form-control" 
                                id="promptInput" 
                                rows="6" 
                                placeholder="Enter your prompt here..."
                                required
                            ></textarea>
                        </div>

                        <!-- Advanced Settings (Collapsible) -->
                        <div class="accordion mb-3" id="advancedSettings">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSettings">
                                        <i class="fas fa-cog"></i> Advanced Settings
                                    </button>
                                </h2>
                                <div id="collapseSettings" class="accordion-collapse collapse" data-bs-parent="#advancedSettings">
                                    <div class="accordion-body">
                                        <div class="mb-3">
                                            <label for="temperatureInput" class="form-label">
                                                Temperature: <span id="tempValue">0.7</span>
                                            </label>
                                            <input 
                                                type="range" 
                                                class="form-range" 
                                                id="temperatureInput" 
                                                min="0" 
                                                max="2" 
                                                step="0.1" 
                                                value="0.7"
                                            >
                                            <small class="form-text text-muted">
                                                Controls randomness (0=deterministic, 2=very random)
                                            </small>
                                        </div>
                                        <div class="mb-3">
                                            <label for="maxTokensInput" class="form-label">Max Tokens</label>
                                            <input 
                                                type="number" 
                                                class="form-control" 
                                                id="maxTokensInput" 
                                                value="1000"
                                                min="1"
                                                max="4000"
                                            >
                                            <small class="form-text text-muted">
                                                Maximum length of the response
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-paper-plane"></i> Submit Query
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Panel: Response Display -->
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-reply"></i> Response</h5>
                </div>
                <div class="card-body">
                    <div id="responseArea">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-robot fa-3x mb-3"></i>
                            <p>Submit a query to see the AI response here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Metrics Card -->
            <div class="card shadow-sm mt-3" id="metricsCard" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-1"><strong>Response Time:</strong></p>
                            <p class="text-muted" id="responseTime">-</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Total Requests:</strong></p>
                            <p class="text-muted" id="totalRequests">-</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Model Used:</strong></p>
                            <p class="text-muted" id="modelUsed">-</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Avg Response Time:</strong></p>
                            <p class="text-muted" id="avgResponseTime">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Update temperature display
    document.getElementById('temperatureInput').addEventListener('input', (e) => {
        document.getElementById('tempValue').textContent = e.target.value;
    });

    // Handle form submission
    document.getElementById('queryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const model = document.getElementById('modelSelect').value;
        const prompt = document.getElementById('promptInput').value;
        const temperature = parseFloat(document.getElementById('temperatureInput').value);
        const maxTokens = parseInt(document.getElementById('maxTokensInput').value);
        
        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        const responseArea = document.getElementById('responseArea');
        responseArea.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Querying <span id="loadingModel"></span>...</p>
            </div>
        `;
        document.getElementById('loadingModel').textContent = model;
        
        try {
            const response = await fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: model,
                    prompt: prompt,
                    temperature: temperature,
                    max_tokens: maxTokens
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Display response
                responseArea.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> Response received</h6>
                    </div>
                    <div class="response-text">
                        <pre class="bg-light p-3 rounded">${escapeHtml(data.response)}</pre>
                    </div>
                `;
                
                // Display metrics
                document.getElementById('metricsCard').style.display = 'block';
                document.getElementById('responseTime').textContent = data.metrics.response_time.toFixed(2) + 's';
                document.getElementById('totalRequests').textContent = data.metrics.total_requests;
                document.getElementById('modelUsed').textContent = data.model;
                document.getElementById('avgResponseTime').textContent = data.metrics.average_response_time.toFixed(2) + 's';
            } else {
                responseArea.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Error</h6>
                        <p class="mb-0">${data.error}</p>
                    </div>
                `;
            }
        } catch (error) {
            responseArea.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Network Error</h6>
                    <p class="mb-0">${error.message}</p>
                </div>
            `;
        } finally {
            // Restore button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    });
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
