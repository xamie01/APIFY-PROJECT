{% extends "base.html" %}

{% block title %}Sandbox - O-SATE{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-box"></i> Sandbox Management</h2>
            <p class="text-muted">Create and manage isolated Docker sandbox environments for safe code execution</p>
        </div>
    </div>

    <div class="row">
        <!-- Left Panel: Sandbox Control -->
        <div class="col-lg-6">
            <!-- Create Sandbox -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Create Sandbox</h5>
                </div>
                <div class="card-body">
                    <form id="createSandboxForm">
                        <div class="mb-3">
                            <label for="sandboxName" class="form-label">Sandbox Name</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="sandboxName" 
                                placeholder="osate-sandbox-1"
                                required
                            >
                            <small class="form-text text-muted">
                                Unique name for this sandbox container
                            </small>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success" id="createBtn">
                                <i class="fas fa-plus"></i> Create Sandbox
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Execute Code -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-terminal"></i> Execute Code</h5>
                </div>
                <div class="card-body">
                    <form id="executeForm">
                        <div class="mb-3">
                            <label for="targetSandbox" class="form-label">Target Sandbox</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="targetSandbox" 
                                placeholder="osate-sandbox-1"
                                required
                            >
                        </div>
                        <div class="mb-3">
                            <label for="commandInput" class="form-label">Command</label>
                            <textarea 
                                class="form-control font-monospace" 
                                id="commandInput" 
                                rows="4" 
                                placeholder="python -c 'print(\"Hello from sandbox!\")'"
                                required
                            ></textarea>
                            <small class="form-text text-muted">
                                Enter the command to execute in the sandbox
                            </small>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="executeBtn">
                                <i class="fas fa-play"></i> Execute
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Right Panel: Output and Stats -->
        <div class="col-lg-6">
            <!-- Execution Output -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-terminal"></i> Execution Output</h5>
                </div>
                <div class="card-body">
                    <div id="outputArea">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-code fa-3x mb-3"></i>
                            <p>Execute code to see output here</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sandbox Statistics -->
            <div class="card shadow-sm" id="statsCard" style="display: none;">
                <div class="card-header bg-warning">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Sandbox Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-1"><strong>CPU Usage:</strong></p>
                            <p class="text-muted" id="cpuUsage">-</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Memory Usage:</strong></p>
                            <p class="text-muted" id="memoryUsage">-</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Execution Time:</strong></p>
                            <p class="text-muted" id="execTime">-</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-1"><strong>Status:</strong></p>
                            <p class="text-muted" id="execStatus">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Sandboxes Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Active Sandboxes</h5>
                </div>
                <div class="card-body">
                    <div id="activeSandboxesList">
                        <p class="text-muted text-center py-3">No active sandboxes</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Create sandbox
    document.getElementById('createSandboxForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const name = document.getElementById('sandboxName').value;
        const createBtn = document.getElementById('createBtn');
        const originalBtnText = createBtn.innerHTML;
        
        createBtn.disabled = true;
        createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        
        try {
            const response = await fetch('/api/sandbox/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name: name })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('success', `Sandbox "${data.sandbox_name}" created successfully!`);
                document.getElementById('sandboxName').value = '';
                document.getElementById('targetSandbox').value = data.sandbox_name;
            } else {
                showAlert('danger', `Error: ${data.error}`);
            }
        } catch (error) {
            showAlert('danger', `Network error: ${error.message}`);
        } finally {
            createBtn.disabled = false;
            createBtn.innerHTML = originalBtnText;
        }
    });

    // Execute code
    document.getElementById('executeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const sandboxName = document.getElementById('targetSandbox').value;
        const command = document.getElementById('commandInput').value;
        const executeBtn = document.getElementById('executeBtn');
        const originalBtnText = executeBtn.innerHTML;
        
        executeBtn.disabled = true;
        executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Executing...';
        
        const outputArea = document.getElementById('outputArea');
        outputArea.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Executing command...</p>
            </div>
        `;
        
        try {
            const response = await fetch('/api/sandbox/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sandbox_name: sandboxName,
                    command: command
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                const result = data.result;
                
                // Display output
                outputArea.innerHTML = `
                    <div class="mb-3">
                        <h6>Standard Output:</h6>
                        <pre class="bg-light p-3 rounded mb-0">${escapeHtml(result.stdout || '(empty)')}</pre>
                    </div>
                    ${result.stderr ? `
                    <div class="mb-3">
                        <h6>Standard Error:</h6>
                        <pre class="bg-danger text-white p-3 rounded mb-0">${escapeHtml(result.stderr)}</pre>
                    </div>
                    ` : ''}
                `;
                
                // Display stats
                document.getElementById('statsCard').style.display = 'block';
                document.getElementById('execTime').textContent = result.execution_time ? result.execution_time.toFixed(2) + 's' : '-';
                document.getElementById('execStatus').textContent = result.success ? 'Success' : 'Failed';
                
                if (result.success) {
                    showAlert('success', 'Command executed successfully!');
                } else {
                    showAlert('warning', 'Command execution completed with errors');
                }
            } else {
                outputArea.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="fas fa-exclamation-triangle"></i> Error</h6>
                        <p class="mb-0">${data.error}</p>
                    </div>
                `;
            }
        } catch (error) {
            outputArea.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle"></i> Network Error</h6>
                    <p class="mb-0">${error.message}</p>
                </div>
            `;
        } finally {
            executeBtn.disabled = false;
            executeBtn.innerHTML = originalBtnText;
        }
    });

    // Helper functions
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 5000);
    }
</script>
{% endblock %}
